!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).g={})}(this,(function(t){"use strict";function i(t){let i=t.indexOf("d3.timeParse")+14,s=t.slice(i),e=s.indexOf(")")-1;return s.slice(0,e)}function s(t,i=!0,s){let e=t;if(t.every((t=>t instanceof Date))){let i=(t,i)=>t==i?0:t>i?1:-1;s=s||i,e=[...new Set(t.map((t=>t.getTime())))].map((t=>new Date(t)))}else t.every((t=>"number"==typeof t))?(s=s||((t,i)=>t-i),e=Array.from(new Set(t))):e=Array.from(new Set(t));return i?e.sort(s):e}function e(t){return`.${Math.abs(Math.floor(Math.log10(t>0?t:1)))+1}%`}function o(t,i){for(const s of Object.keys(i))Object.keys(t).indexOf(s)>-1&&null!=i[s]&&i[s].constructor==Object?o(t[s],i[s]):t[s]=i[s]}function a(t,i){let s=document.createElement("div");s.style.cssText=`position:absolute;visibility:hidden;width:auto;height:auto;white-space:nowrap;font-size:${i}`,s.setAttribute("id","element_compute_dim"),document.body.appendChild(s),s=document.getElementById("element_compute_dim"),s.innerHTML=t;let e=s.clientWidth,o=s.clientHeight;return s.remove(),{width:e,height:o}}function n(t,i,s="|"){return t.split("").reduce(((t,e,o)=>t.split(s).slice(-1)[0].length>i&&" "===e?t.concat(s):t.concat(e)),"").split(s)}function l(t,i,s="field_id",e="field_value"){let o={},a=Array.isArray(i)?i:[i];for(const i of t){let t=[];for(const s of a)t.push(i[s]);if(!o.hasOwnProperty(t)){o[t]={};for(const s of a)o[t][s]=i[s]}o[t][i[s]]=i[e]}return Object.values(o)}function r(t,i,s){let e=t.match(/(rgb|rgba|hsl)/)[0],o=t=>t.replace(/( |rgb|rgba|hsl|\(|\))/g,"").split(",").map((t=>parseInt(t)));return t=o(t),i=o(i),`${e}(${t.map(((t,e)=>s*t+(1-s)*(i[e]||0)))})`}function h(t,i="rgb(255, 255, 255)"){let s=window.getComputedStyle(t).backgroundColor;for(;"rgba(0, 0, 0, 0)"===s||"transparent"===s;){if(null==(t=t.parentElement))return i;s=window.getComputedStyle(t).backgroundColor}return s}class p{constructor(t,i,s=null,e=null){this.id=t,this.type=i,this.el=document.getElementById(this.id),this.width=s||this.el.offsetWidth,this.height=e||this.el.offsetHeight,this._fontSize=parseFloat(window.getComputedStyle(this.el).fontSize),this.container=d3.select(`#${this.id}`).append("span").attr("class","grapherContainer").attr("width",this.width).attr("height",this.height),this.svgWidth=this.width,this.svgHeight=this.height,this.svg=this.container.append("svg").attr("id",this.id+"_svg").attr("class",`grapher ${i}`).attr("width",this.svgWidth).attr("height",this.svgHeight),this._style={color:window.getComputedStyle(this.el).color,backgroundColor:h(this.el),fontSize:parseFloat(window.getComputedStyle(this.el).fontSize)},this._margin={},this.margin={}}wipe(){this.g.selectAll(":not(.overlay)").remove(),this.container.selectAll(".sparkText").remove()}downloadData(){let t=document.createElement("a");t.id="download",t.download=this._options.download.filename||"grapher_data.csv",t.href=URL.createObjectURL(new Blob([Grapher.to_csv(this.data)])),t.click()}}const d=["#1abb9b","#3497da","#9a59b5","#f0c30f","#e57e22","#e64c3c","#7f8b8c","#CC6666","#9999CC","#66CC99"];class c extends p{constructor(t,i="line",s={},e=null,o=null){super(t,i,e,o),this._options=this._defaultOptions(i),this.options=s,this.isSparkline=this.type.includes("sparkline"),this.isBar=this.type.includes("bar")}get margin(){return this._margin}set margin({top:t=10,right:i=(t=>t<400?20:30),bottom:s,left:e=(t=>t<400?40:60)}={}){this._margin={top:t,right:"function"==typeof i?i(this.svgWidth):i,bottom:s||2*this._style.fontSize+20,left:"function"==typeof e?e(this.svgWidth):e},this._innerDimensions()}_innerDimensions(){this.innerWidth=this.svgWidth-this._margin.left-this._margin.right,this.innerHeight=this.svgHeight-this._margin.top-this._margin.bottom,this._createSVG()}_createSVG(){this.svg.select(`#${this.id}_g`).remove(),this.g=this.svg.append("g").attr("id",this.id+"_g").attr("transform",`translate(${this._margin.left},${this._margin.top})`),this._addOverlay()}_addOverlay(){this.g.append("rect").attr("class","overlay").attr("fill","none").attr("style","pointer-events:all;").attr("width",this.innerWidth).attr("height",this.innerHeight)}get options(){return this._options}set options(t){o(this._options,t),t.category||this._options.category.name?!this._options.categories&&this._options.category.name?this._options._categories=s(this._options.data.map((t=>t[this._options.category.name]))):this._options._categories=this._options.categories:this._options._categories=[this._options.y.label]||[this._options.y.name],t.x&&!t.x.scale&&t.x.parse&&t.x.parse.toString().match(/(d3.timeParse|new Date)/g)&&(this._options.x.scale="scaleTime"),t.y&&!t.y.scale&&t.y.parse&&t.y.parse.toString().match(/(d3.timeParse|new Date)/g)&&(this._options.y.scale="scaleTime"),t.x&&!t.x.tickFormat&&t.x.parse&&t.x.parse.toString().includes("d3.timeParse")&&(this._options.x.tickFormat=d3.timeFormat(i(t.x.parse.toString()))),t.y&&!t.y.tickFormat&&t.y.parse&&t.y.parse.toString().includes("d3.timeParse")&&(this._options.y.tickFormat=d3.timeFormat(i(t.y.parse.toString()))),this.color=d3.scaleOrdinal().domain(this._options._categories).range(this._options.style.colors),(!this.data||t.data||t.x&&t.x.parse||t.y&&t.y.parse||t.categories)&&this._parseData(),this.margin={left:this._options.y.label?80:60,bottom:this._options.x.label?2*this._style.fontSize+20:40},this.isSparkline&&(this._options.style.strokeWidth=this._options.sparkline.strokeWidth),this.isBar=this._options.type.includes("bar"),!this._options.type.includes("stacked")||this.stackedData&&!t.data||(this.wideData=l(this.data,this._options.x.name,this._options.category.name,this._options.y.name),this.stackedData=d3.stack().keys(this._options.categories||s(this.data.map((t=>t[this._options.category.name])))).value(((t,i)=>t[i]||0)).offset(d3.stackOffsetDiverging)(this.wideData))}_parseData(){if(this._options.x.parse||this._options.y.parse||this._options.categories.length>0){let t=[],i=this._options.category.name&&this._options.categories.length>0;for(const s of this._options.data)if(!i||this._options.categories.indexOf(s[this._options.category.name])>-1){let i={};i[this._options.x.name]=this._options.x.parse?this._options.x.parse(s[this._options.x.name]):s[this._options.x.name],i[this._options.y.name]=this._options.y.parse?this._options.y.parse(s[this._options.y.name]):s[this._options.y.name],this._options.category.name?i[this._options.category.name]=s[this._options.category.name]:i.category=this._options.y.label||this._options.y.name;for(const t of this._options.advanced.additionalColumnsInData)i[t]=s[t];t.push(i)}this.data=t,this._options.category.name=this._options.category.name||"category"}else this.data=JSON.parse(JSON.stringify(this._options.data))}extent(t,i,s=!1,e=this.data){if("scaleLog"==i){return[d3.min(e.filter((i=>i[t]>0)),(i=>i[t])),d3.max(e,(i=>i[t]))]}return s?[Math.min(d3.min(e,(i=>i[t])),0),d3.max(e,(i=>i[t]))]:d3.extent(e,(i=>i[t]))}draw(t){t&&(this.options=t),this.g.selectAll("g.x.axis").remove(),this.g.selectAll("g.y.axis").remove(),this.g.selectAll("g.yGrid").remove(),this._addX(),this.isBar&&this._addX2(),this._options.x.label&&this._addXLabel(),this._addY(),this._options.y.label&&this._addYLabel(),this._options.grid.y.lines.length>0&&this._addYGridLines(),this._options.grid.x.lines.length>0&&this._addXGridLines(),this._draw(),this._addTooltip(),this._options.legend.show&&this._addLegend()}_defaultOptions(t){return{data:[],x:{name:"x",scale:"scaleLinear",tickFormat:d3.format(".3s"),parse:null,label:null,domain:null,nice:!1,padding:null,values:null},y:{name:"y",scale:"scaleLinear",tickFormat:d3.format(".3s"),parse:null,label:null,domain:null,nice:!0},category:{name:null,parse:t=>t},categories:!1,type:t,style:{colors:d,barWidth:.8,strokeWidth:3,dotSize:4,grid:!0,tooltipColor:this._style.color,tooltipBackgroundColor:this._style.backgroundColor,tooltipOpacity:"0.8",tooltipLineColor:this._style.color,tooltipFormat:(t,i)=>0===i?this._options.x.tickFormat(t):`${this._options.category.parse(t[this._options.category.name])}: ${this._options.y.tickFormat(t[this._options.y.name])||d3.format(".3s")(t[this._options.y.name])}`,tooltipDotColor:t=>this.color(t[this._options.category.name]),tooltipDotSize:5,beautifyClosestLine:"widen"},legend:{show:!0,x:15,y:this._margin.top,interstice:25,backgroundColor:this._style.backgroundColor,opacity:"0.9"},download:{filename:`data_${this.id}_${Date.now()}.csv`},grid:{x:{show:!1,lines:[]},y:{show:!0,lines:[]}},advanced:{additionalColumnsInData:[]}}}_style(t,i,s){let e=t.attr("style").split(";").filter((t=>t.length>0)).map((t=>t.replace(" ","").split(":"))).reduce(((t,[i,s])=>(t[i]=s,t)),{});return e[i]=s,t.attr("style",Object.entries(e).map((t=>t.join(":"))).join(";")),e}_getXDomain(){return this._options.x.domain?this._options.x.domain:["scaleBand","scaleOrdinal"].indexOf(this._options.x.scale)>-1?this.xValues:this.extent(this._options.x.name,this._options.x.scale)}_scaleBandInvert(t){let i,s=this.domain().length,e=this.range()[1]<this.range()[0],o=this.range()[e-0],a=this.range()[1-e];return i=t<o+this.paddingOuter()*this.step()?0:t>a-this.paddingOuter()*this.step()?s-1:Math.floor((t-o-this.paddingOuter()*this.step())/this.step()),this.domain()[i]}_addX(){this.xValues=this._options.x.values||s(this.data.map((t=>t[this._options.x.name]))),this.xNbValues=this.xValues.length,this.xWidth=this.innerWidth/this.xNbValues,this.xRange=this.isBar?[this.xWidth/2,this.innerWidth-this.xWidth/2]:[0,this.innerWidth],this.xNbTicks=d3.min([parseInt((this.svgWidth-100)/100),this.xNbValues]),this.x=d3[this._options.x.scale]().domain(this._getXDomain()).range(this.xRange),this._options.x.padding&&"scaleBand"==this._options.x.scale&&(this.x=this.x.padding(this._options.x.padding)),this._options.x.nice&&(this.x=this.x.nice()),this._xLineOffset=this._options.type.includes("stacked")?this.x.bandwidth()/2:0,this.x.invert||(this.x.invert=this._scaleBandInvert),this.g.append("g").attr("class","x axis").attr("transform",`translate(0, ${this.innerHeight})`).call(d3.axisBottom(this.x).ticks(this.xNbTicks).tickFormat(this._options.x.tickFormat).tickSizeOuter(0)),this.isBar&&this.g.append("g").attr("class","x axis").attr("transform",`translate(0, ${this.innerHeight+.5})`).attr("opacity","1").append("line").attr("stroke","currentColor").attr("x2",this.innerWidth),this._options.grid.x.show&&this._addXGrid()}_addXLabel(){this.g.append("text").attr("class","xLabel axisLabel").attr("transform",`translate(${this.innerWidth/2},${this.svgHeight-this._margin.bottom/2})`).style("text-anchor","middle").style("fill",this._style.color).text(this._options.x.label)}_addX2(){"bar"==this._options.type&&(this.x2=d3.scaleBand().domain(this._options._categories).rangeRound([-this.xWidth/2*this._options.style.barWidth,this.xWidth/2*this._options.style.barWidth]))}_getYDomain(){return this._options.y.domain?this._options.y.domain:this._options.type.includes("stacked")?[d3.min(this.stackedData,(t=>d3.min(t,(t=>t[0])))),d3.max(this.stackedData,(t=>d3.max(t,(t=>t[0]))))]:this.extent(this._options.y.name,this._options.y.scale,"bar"==this._options.type)}_addY(){this.yVar=this._options.y.name,this.y=d3[this._options.y.scale]().domain(this._getYDomain()).range([this.innerHeight,0]),this._options.y.nice&&(this.y=this.y.nice()),this.g.append("g").attr("class","y axis").call(d3.axisLeft(this.y).tickFormat(this._options.y.tickFormat)),this._options.grid.y.show&&this._addYGrid(),this.y.domain()[0]<0&&this.isBar&&this.g.append("g").attr("class","x axis").attr("transform",`translate(0, ${this.y(0)})`).attr("opacity","1").append("line").attr("stroke","currentColor").attr("x2",this.innerWidth)}_addYGrid(){this.yNbTicks="scaleLog"==this._options.y.scale?Math.round(Math.log10(this.y.domain()[1])-Math.log10(this.y.domain()[0])):parseInt(this.innerHeight/40),this.yGrid=t=>t.call(d3.axisRight(this.y).ticks(this.yNbTicks).tickSize(this.innerWidth).tickFormat(this._options.y.tickFormat)).call((t=>t.selectAll(".domain").remove())).call((t=>t.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity",.5).attr("stroke-dasharray","2,2"))).call((t=>t.selectAll(".tick:first-of-type line").remove())).call((t=>t.selectAll(".tick text").remove())).call((t=>t.selectAll(".tick line").attr("class","y-grid"))),this.g.append("g").attr("class","yGrid").call(this.yGrid)}_addXGrid(){this.xGrid=t=>t.call(d3.axisBottom(this.x).tickSize(this.innerHeight).ticks(this.xNbTicks).tickFormat(this._options.x.tickFormat)).call((t=>t.selectAll(".domain").remove())).call((t=>t.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity",.5).attr("stroke-dasharray","2,2"))).call((t=>t.selectAll(".tick:first-of-type line").remove())).call((t=>t.selectAll(".tick text").remove())).call((t=>t.selectAll(".tick line").attr("class","x-grid"))),this.g.append("g").attr("class","xGrid").call(this.xGrid)}_addYGridLines(){for(const t of this._options.grid.y.lines)this.g.append("g").attr("class",`y grid-line ${t.class||""}`).attr("transform",`translate(0, ${this.y(t.y)})`).attr("opacity","1").append("line").attr("class",`${t.class||""}`).attr("stroke","currentColor").attr("x2",this.innerWidth),t.label&&(t.textAnchor=t.textAnchor||t.position||"middle",t.xox=this.x(t.x)||(t.position?"middle"==t.position?this.innerWidth/2:"start"==t.position?this.margin.left:this.innerWidth-this.margin.right:this.margin.left),this.g.append("text").attr("y",this.y(t.y)).attr("x",t.xox).attr("dy","1em").attr("class",`grid-line-label ${t.class||""}`).attr("style","font-size:0.8rem").style("text-anchor",t.textAnchor).style("fill",this._style.color).text(t.label))}_addXGridLines(){for(const t of this._options.grid.x.lines)this.g.append("g").attr("class",`x grid-line ${t.class||""}`).attr("transform",`translate(${this.x(t.x)}, 0)`).attr("opacity","1").append("line").attr("class",`${t.class||""}`).attr("stroke","currentColor").attr("y2",this.innerHeight),t.label&&(t.textAnchor=t.textAnchor||t.position||"middle",t.yoy=this.y(t.y)||(t.position?"middle"==t.position?this.innerHeight/2:"start"==t.position?this.innerHeight-this.margin.top:this.margin.top:this.margin.top),this.g.append("text").attr("transform",`rotate(-90,${this.x(t.x)},${t.yoy})`).attr("y",t.yoy).attr("x",this.x(t.x)).attr("dy","1em").attr("class",`grid-line-label ${t.class||""}`).attr("style","font-size:0.8rem").style("text-anchor",t.textAnchor).style("fill",this._style.color).text(t.label))}_addYLabel(){this.g.append("text").attr("transform","rotate(-90)").attr("y",0-this._margin.left).attr("x",0-this.innerHeight/2).attr("dy","1em").attr("class","yLabel axisLabel").style("text-anchor","middle").style("fill",this._style.color).text(this._options.y.label)}_draw(){this.g.selectAll("path.lines").remove(),this.g.selectAll("rect.bar").remove(),this.g.selectAll("circle.dots").remove(),this._paths={};for(const t of this._options._categories)["line","dotted-line"].indexOf(this._options.type)>-1&&(this._paths[t]=this.g.append("path").datum(this.data.filter((i=>i[this._options.category.name]===t))).attr("class","lines").attr("fill","none").attr("stroke",(i=>this.color(t))).attr("stroke-width",this._options.style.strokeWidth).attr("d",d3.line().y((t=>this.y(t[this._options.y.name]))).defined((t=>null!==t[this._options.y.name])).x((t=>this.x(t[this._options.x.name]))))),"bar"==this._options.type&&this.x2.bandwidth()>0&&this.g.selectAll(`rect.bar.${t.replace(/[^a-z0-9A-Z]/g,"")}`).data(this.data.filter((i=>i[this._options.category.name]===t))).join("rect").attr("class",`bar ${t.replace(/[^a-z0-9A-Z]/g,"")}`).attr("fill",(i=>this.color(t))).attr("x",(i=>this.x(i[this._options.x.name])+this.x2(t))).attr("width",this.x2.bandwidth()).attr("y",(t=>t[this._options.y.name]>0?this.y(t[this._options.y.name]):this.y(0))).attr("height",(t=>Math.abs((this.y(0)||this.y(this.y.domain()[0]))-this.y(t[this._options.y.name])))).on("mouseover",(function(t){d3.select(this).attr("fill",(function(){return d3.rgb(d3.select(this).style("fill")).darker(.5)}))})).on("mouseout",(function(t){d3.select(this).attr("fill",(function(){return d3.rgb(d3.select(this).style("fill")).brighter(.5)}))}));if(["dotted-line","dot"].indexOf(this._options.type)>-1&&this.g.selectAll("circle").data(this.data).join("circle").style("fill",(t=>this.color(t[this._options.category.name]))).attr("class","dots").attr("r",this._options.style.dotSize).attr("cx",((t,i)=>this.x(t[this._options.x.name]))).attr("cy",((t,i)=>this.y(t[this._options.y.name]))),"stacked-bar"==this._options.type&&this.g.append("g").attr("class","stackedBar").selectAll("g.stackedBar").data(this.stackedData).join("g").attr("fill",(t=>this.color(t.key))).selectAll("rect").data((t=>t)).join("rect").attr("class","bar").attr("x",(t=>this.x(t.data[this._options.x.name]))).attr("width",this.x.bandwidth()).attr("y",(t=>this.y(t[1]))).attr("height",(t=>Math.abs(this.y(t[0])-this.y(t[1])))).on("mouseover",(function(t){d3.select(this).attr("fill",(function(){return d3.rgb(d3.select(this).style("fill")).darker(.5)}))})).on("mouseout",(function(t){d3.select(this).attr("fill",(function(){return d3.rgb(d3.select(this).style("fill")).brighter(.5)}))})),"stacked-area"==this._options.type&&(this.area=d3.area().x((t=>this.x(t.data[this._options.x.name]))).y0((t=>this.y(t[0]<=t[1]?t[0]:0))).y1((t=>this.y(t[0]<=t[1]?t[1]:t[1]-t[0]))),this.g.append("g").attr("class","stackedArea").selectAll("g.stackedArea").data(this.stackedData).join("path").attr("fill",(t=>this.color(t.key))).attr("d",(t=>this.area(t)))),"bar"==this._options.type&&this.x2.bandwidth()<1){let t=this.g.append("g").attr("class","alert_barzerowidth").attr("x",10).attr("y",10),i=n("WARNING: Graph cannot be plotted because there are too many bars to be displayed compare to the available width.",Math.floor(this.innerWidth/this._style.fontSize));t.selectAll("rect.alert_barzerowidth").data([null]).join("rect").attr("class","alert_barzerowidth").attr("style",`fill:${this._options.style.tooltipBackgroundColor}; fill-opacity: ${this._options.style.tooltipOpacity};`),t.selectAll("text.alert_barzerowidth").data([null]).join("text").call((t=>t.selectAll("tspan").data(i).join("tspan").attr("x",20).attr("y",((t,s)=>this.innerHeight/2+1.1*(s-i.length/2)*this._style.fontSize+"px")).attr("class","tooltip_text").style("font-weight","bold").style("font-size","1em").style("fill","red").text(((t,i)=>t))))}}_buildTooltip(t,i,s,e){if(!i)return t.style("display","none");t.style("display",null);t.selectAll("line").data([null]).join("line").attr("class","tooltip_line").attr("style",`stroke: ${this._options.style.tooltipLineColor};`).attr("x1",s+this._xLineOffset).attr("x2",s+this._xLineOffset).attr("y1",0).attr("y2",this.innerHeight);if(!this.isBar&&!this._options.type.includes("stacked")){t.selectAll("circle").data(i.slice(1)).join("circle").style("fill",(t=>this._options.style.tooltipDotColor(t))).attr("r",this._options.style.tooltipDotSize).attr("cx",((t,i)=>this.x(t[this._options.x.name]))).attr("cy",((t,i)=>this.y(t[this._options.y.name])))}const o=t.selectAll("rect").data([null]).join("rect").attr("class","rect_tooltip").attr("style",`fill:${this._options.style.tooltipBackgroundColor}; fill-opacity: ${this._options.style.tooltipOpacity};`);let a=t.selectAll("text").data([null]).join("text").call((t=>t.selectAll("tspan").data(i).join("tspan").attr("x",0).attr("y",((t,i)=>1.1*i+"em")).attr("class","tooltip_text").style("font-weight","bold").style("fill",((t,i)=>0===i?"function"==typeof this._options.style.tooltipColor?this._options.style.tooltipColor():this._options.style.tooltipColor:this.color(t[this._options.category.name]))).text(((t,i)=>this._options.style.tooltipFormat(t,i)))));const{xx:n,yy:l,width:r,height:h}=a.node().getBBox();let p=r+s+this._xLineOffset+10>this.innerWidth?s+this._xLineOffset-r-10:s+this._xLineOffset+10,d=e-20<0?e+20:e+h-10>this.innerHeight?this.innerHeight-h+10:e;return a.attr("transform",`translate(${p},${d})`),o.attr("x",p-5).attr("y",d-20).attr("rx",5).attr("width",r+10).attr("height",h+10),!0}_getMouseData(t){let i=this.x.invert(t),s=d3.bisector((t=>t)).left(this.xValues,i),e=s>0?this.xValues[s-1]:0,o=s>this.xValues.length-1?this.xValues.slice(-1)[0]:this.xValues[s],a="string"==typeof i?i:i-e>o-i?o:e,n=this.data.filter((t=>t[this._options.x.name].toString()==a.toString())).sort(((t,i)=>i[this._options.y.name]-t[this._options.y.name]));return[a].concat(n)}_widenClosestLine(t,i){if(this.hasOwnProperty("_paths")&&this._options.style.widenClosestLine){let s=null;t&&(s=t.slice(1).sort(((t,s)=>Math.abs(t[this._options.y.name]-i)-Math.abs(s[this._options.y.name]-i)))[0][this._options.category.name]);for(const[t,i]of Object.entries(this._paths))t===s?(i.attr("stroke-width",this._options.style.strokeWidth+1),this.isSparkline&&this._options.sparkline.textLastPoint&&(this._style(this._sparkTextLastPoints[t],"display","inline-block"),this._style(this._sparkTextYLabels[t],"display","inline-block"))):(i.attr("stroke-width",this._options.style.strokeWidth),this.isSparkline&&this._options.sparkline.textLastPoint&&(this._style(this._sparkTextLastPoints[t],"display","none"),this._style(this._sparkTextYLabels[t],"display","none")))}}_beautifyClosestLine(t,i,s=null){if("widen"===s?s=this._widenClosestLine:"color"===s&&(s=this._colorClosestLine),this.hasOwnProperty("_paths")&&s){let e=null;t&&(e=t.slice(1).sort(((t,s)=>Math.abs(t[this._options.y.name]-i)-Math.abs(s[this._options.y.name]-i)))[0][this._options.category.name]);for(const[t,i]of Object.entries(this._paths))s(this,t===e,i,t)}}_widenClosestLine(t,i,s,e){i?s.attr("stroke-width",t._options.style.strokeWidth+1):s.attr("stroke-width",t._options.style.strokeWidth)}_colorClosestLine(t,i,s,e){i?s.attr("stroke",(i=>t.color(e))):s.attr("stroke",(t=>"#ccc"))}_addTooltip(){this.g.selectAll("g.tooltip_container").remove(),this.tooltip=this.g.append("g").attr("class","tooltip_container");let t=this;this.g.on("touchmove mousemove",(i=>{let s=d3.pointer(i)[0],e=d3.pointer(i)[1];if(s>0){let i=t._getMouseData(s);t._buildTooltip(t.tooltip,i,t.x(i[0]),e),t._beautifyClosestLine(i,t.y.invert(e),this._options.style.beautifyClosestLine)}})),this.g.on("touchend mouseleave",(()=>{this.tooltip.call(this._buildTooltip,null),this._beautifyClosestLine(null,null)}))}_addLegend(){let t,i,s,e;this.g.selectAll(".legend").remove(),this.legend=this.g.append("g").attr("class","legend"),this.legendBackground=this.legend.selectAll("rect").data([null]).join("rect").attr("class","rect_legend").attr("style",`fill:${this._options.legend.backgroundColor}; fill-opacity: ${this._options.legend.opacity};`),this.legendDots=this.legend.selectAll(".dots-legend").data(this._options._categories),this.legendDots.exit().remove(),this.legendDots.enter().append("circle").merge(this.legendDots).attr("cx",this._options.legend.x+10).attr("cy",((t,i)=>this._options.legend.y+i*this._options.legend.interstice)).attr("r",3).attr("class","dots-legend").style("fill",(t=>this.color(t))),this.legendLabels=this.legend.selectAll(".labels-legend").data(this._options._categories),this.legendLabels.exit().remove(),this.legendLabels.enter().append("text").merge(this.legendLabels).attr("x",this._options.legend.x+30).attr("y",((t,i)=>this._options.legend.y+i*this._options.legend.interstice)).style("fill",(t=>this.color(t))).text((t=>this._options.category.parse(t))).attr("text-anchor","left").style("alignment-baseline","middle").attr("class","labels-legend");try{let o=this.legend.node().getBBox();t=o.x,i=o.y,s=o.width,e=o.height}catch(o){t=85,i=5,s=0,e=0}this.legendBackground.attr("x",this._options.legend.x-5).attr("y",this._options.legend.y-10).attr("width",s>0?s+20:10*d3.max(this._options._categories.map((t=>t.length)))+10).attr("height",e>0?e+10:this._options._categories.length*this._options.legend.interstice+10)}}class _ extends c{constructor(t,i="sparkline",s={},e=null,a=null){super(t,i,s,e,a);let n={style:{tooltipDotColor:t=>this._options.sparkline["circle-color"],tooltipDotSize:2},sparkline:{range:null,textLastPoint:!0,strokeWidth:1,lineColor:this._style.color,circleColor:"#f00",textColor:"#f00",textFontSize:"85%",textFontWeight:"600",rangeFillColor:r(this._style.color,this._style.backgroundColor,.2)}};o(n,s),this.options=n}draw(t){t&&(this.options=t),this._svgSetWidth(),"sparkline"==this._options.type?this._sparkline():"sparklines"==this._options.type&&this._sparklines(),this._addTooltip()}_svgSetWidth(){if(this.sparkTextWidth=0,this._options.sparkline.textLastPoint){this.lastPoint=this.data.slice(-1)[0];let t=this._options.y.tickFormat(this.lastPoint);this.sparkTextWidth+=a(t,this._options.sparkline.textFontSize).width}this._options.y.label&&(this.sparkTextWidth+=a(this._options.y.label,this._options.sparkline.textFontSize).width+6.4),this.svgWidth=this.width-this.sparkTextWidth,this.svg.attr("width",this.svgWidth)}_sparkline(){if(this.x=d3.scaleLinear().range([0,this.svgWidth-2]).domain(this._options.x.domain?this._options.x.domain:this.extent(this._options.x.name,this._options.x.scale)),this.xValues=s(this.data.map((t=>t[this._options.x.name]))),this.y=d3.scaleLinear().range([this.svgHeight-4,0]).domain(this._options.y.domain?this._options.y.domain:this.extent(this._options.y.name,this._options.y.scale)),this.svg.selectAll("g.sparkline").remove(),this.container.attr("style","vertical-align:middle; display:inline-block;"),this.g.attr("transform","translate(0,2)").attr("class","sparkline"),this._options.sparkline.range){let t=this.data.map((t=>(t.minRange=this._options.sparkline.range[0],t.maxRange=this._options.sparkline.range[1],t)));this.g.append("path").datum(t).attr("fill",this._options.sparkline.rangeFillColor).attr("stroke","none").attr("d",d3.area().x((t=>this.x(t[this._options.x.name]))).y0((t=>this.y(t.minRange))).y1((t=>this.y(t.maxRange))))}this.sparkLine=this.g.append("path").datum(this.data).attr("class","sparkLine").attr("fill","none").attr("stroke-width",this._options.style.strokeWidth).attr("stroke",this._options.sparkline.lineColor).attr("d",d3.line().curve(d3.curveBasis).x((t=>this.x(t[this._options.x.name]))).y((t=>this.y(t[this._options.y.name])))),this.lastPoint=this.data.slice(-1)[0],this.sparkCircle=this.g.append("circle").attr("class","sparkCircle").attr("cx",this.x(this.lastPoint[this._options.x.name])).attr("cy",this.y(this.lastPoint[this._options.y.name])).attr("r",1.5).attr("fill",this._options.sparkline.circleColor).attr("stroke","none"),this.container.selectAll(".sparkText").remove(),this._options.sparkline.textLastPoint&&(this.sparkTextLastPoint=this.container.append("span").attr("class","sparkText").text(this._options.y.tickFormat(this.lastPoint[this._options.y.name])).attr("style",`font-size:${this._options.sparkline.textFontSize}; font-weight:${this._options.sparkline.textFontWeight}; color: ${this._options.sparkline.textColor}; margin-bottom:${this.svgHeight/2}; vertical-align:middle; display:inline-block;`)),this._options.y.label&&(this.sparkTextYLabel=this.container.append("span").attr("class","sparkText").text(this._options.y.label).attr("style",`font-size:${this._options.sparkline.textFontSize}; font-weight:${this._options.sparkline.textFontWeight}; margin-bottom:${this.svgHeight/2}; vertical-align:middle; display:inline-block; padding-left: 0.4rem;`))}_sparklines(){if(this.x=d3.scaleLinear().range([0,this.svgWidth-2]).domain(this._options.x.domain?this._options.x.domain:this.extent(this._options.x.name,this._options.x.scale)),this.xValues=s(this.data.map((t=>t[this._options.x.name]))),this.y=d3.scaleLinear().range([this.svgHeight-4,0]).domain(this._options.y.domain?this._options.y.domain:this.extent(this._options.y.name,this._options.y.scale)),this.svg.selectAll("g.sparkline").remove(),this.container.attr("style","vertical-align:middle; display:inline-block;"),this.g.attr("transform","translate(0,2)").attr("class","sparkline"),this._options.sparkline.range){let t=this.data.map((t=>(t.minRange=this._options.sparkline.range[0],t.maxRange=this._options.sparkline.range[1],t)));this.g.append("path").datum(t).attr("fill",this._options.sparkline.rangeFillColor).attr("stroke","none").attr("d",d3.area().x((t=>this.x(t[this._options.x.name]))).y0((t=>this.y(t.minRange))).y1((t=>this.y(t.maxRange))))}this.container.selectAll(".sparkText").remove(),this._paths={},this._sparkTextLastPoints={},this._sparkTextYLabels={};for(const t of this._options._categories){let i=this.data.filter((i=>i[this._options.category.name]===t));this._paths[t]=this.g.append("path").datum(i).attr("class","sparkLine").attr("fill","none").attr("stroke-width",this._options.style.strokeWidth).attr("stroke",this.color(t)).attr("d",d3.line().curve(d3.curveCatmullRom).x((t=>this.x(t[this._options.x.name]))).y((t=>this.y(t[this._options.y.name])))),this.lastPoint=i.slice(-1)[0],this.sparkCircle=this.g.append("circle").attr("class","sparkCircle").attr("cx",this.x(this.lastPoint[this._options.x.name])).attr("cy",this.y(this.lastPoint[this._options.y.name])).attr("r",1.5).attr("fill",this.color(t)).attr("stroke","none"),this._options.sparkline.textLastPoint&&(this._sparkTextLastPoints[t]=this.container.append("span").attr("class",`sparkText ${t}`).text(this._options.y.tickFormat(this.lastPoint[this._options.y.name])).attr("style",`font-size:${this._options.sparkline.textFontSize}; font-weight:${this._options.sparkline.textFontWeight}; color: ${this.color(t)}; margin-bottom:${this.svgHeight/2}; vertical-align:middle; display: none;`),this._sparkTextYLabels[t]=this.container.append("span").attr("class",`sparkText ${t}`).text(t).attr("style",`font-size:${this._options.sparkline.textFontSize}; font-weight:${this._options.sparkline.textFontWeight}; margin-bottom:${this.svgHeight/2}; vertical-align:middle; padding-left: 0.4rem; display: none;`))}}_buildTooltip(t,i,s,e){if(!i)return t.style("display","none");t.style("display",null);t.selectAll("line").data([null]).join("line").attr("class","tooltip_line").attr("style",`stroke: ${this._options.style.tooltipLineColor};`).attr("x1",s).attr("x2",s).attr("y1",0).attr("y2",this.innerHeight);if("bar"!=this._options.type){t.selectAll("circle").data(i.slice(1)).join("circle").style("fill",(t=>this._options.style.tooltipDotColor(t))).attr("r",this._options.style.tooltipDotSize).attr("cx",((t,i)=>this.x(t[this._options.x.name]))).attr("cy",((t,i)=>this.y(t[this._options.y.name])))}const o=t.selectAll("rect").data([null]).join("rect").attr("class","rect_tooltip").attr("style",`fill:${this._options.style.tooltipBackgroundColor}; fill-opacity: ${this._options.style.tooltipOpacity};`);let a=t.selectAll("text").data([null]).join("text").call((t=>t.selectAll("tspan").data(i.slice(1)).join("tspan").attr("x",0).attr("y",((t,i)=>1.1*i+"em")).attr("class","tooltip_text").style("fill",((t,i)=>this._options.style.tooltipColor)).text(((t,i)=>`${this._options.y.tickFormat(t[this._options.y.name])}`)).attr("style",`font-size:${this._options.sparkline.textFontSize};`)));const{xx:n,yy:l,width:r,height:h}=a.node().getBBox();let p=r+s>this.svgWidth?s-r:s,d=e-5<0?e+5:e+h>this.innerHeight?this.innerHeight-h:e;return a.attr("transform",`translate(${p},${d})`),o.attr("x",p).attr("y",d-11).attr("rx",5).attr("width",r).attr("height",h),!0}get margin(){return this._margin}set margin({top:t=10,right:i=(t=>t<400?20:30),bottom:s,left:e=(t=>t<400?40:60)}={}){this._margin={top:0,right:0,bottom:0,left:0},this._innerDimensions()}}class g extends p{constructor(t,i={},s=null,e=null,o="donut"){super(t,o,s,e),this.size=this._size(),this.radius=this._radius(),this._create_g(),this._options=this._defaultOptions(),this.options=i}_size(){return Math.min(this.width,this.height)}_radius(){return.48*this.size}_create_g(){this.g=this.svg.append("g").attr("transform",`translate(${this.size/2},${this.size/2})`)}_defaultOptions(){return{data:[],value:{name:"value",format:t=>t[this._options.value.name],displayPercentage:!1},label:{name:"name",format:t=>t[this._options.label.name]},style:{colors:d,innerRadius:.8*this.radius,outerRadius:.4*this.radius,outerArcRadius:.9*this.radius,padAngle:.03,centerText:{display:!0,format:t=>this._options.data.map((t=>t[this._options.value.name])).reduce(((t,i)=>t+i),0),fontSize:this._style.fontSize},labels:{display:!0,fontSize:.8*this._style.fontSize},labelLines:{display:!0,color:this._style.color},cornerRadius:0,startAngle:-180,endAngle:180,minValue:0,maxValue:100,maxHeight:this.size}}}_draw(){this.g.attr("transform",`translate(${this.size}, ${this.size/2})`),this.pieData=d3.pie().value((t=>t[this._options.value.name]))(this._options.data),this._color=d3.scaleOrdinal(this._options.style.colors),this.outerArc=d3.arc().innerRadius(this._options.style.outerArcRadius).outerRadius(this._options.style.outerArcRadius),this.arc=d3.arc().innerRadius(this._options.style.innerRadius).outerRadius(this._options.style.outerRadius).padAngle(this._options.style.padAngle).cornerRadius(this._options.style.cornerRadius),this.arcs=this.g.selectAll(".arc").data(this.pieData).enter().append("g").attr("class","arc").append("path").attr("d",this.arc).attr("fill",((t,i)=>this._color(i))),this.arcs.exit().remove(),this._options.style.labels.display&&this._labels(),this._options.style.labelLines.display&&this._labelLines(),this._options.style.centerText.display&&this._addCenterValue()}_posText(t,i=!1){let s,e=this.outerArc.centroid(t),o=this._midAngle(t)<Math.PI?1:-1,n=a(this._options.label.format(t.data),this._options.fontSizeLabels),l=a(this._options.value.format(t.data),this._options.fontSizeLabels);return s=i?l.width>n.width?0:n.width-l.width:n.width>l.width?0:l.width-n.width,e[0]=(this.radius+s)*o,e[1]=i?e[1]+l.height:e[1]-.4*n.height,e}_posEndLabelLines(t){let i=this.outerArc.centroid(t),s=this._midAngle(t)<Math.PI?1:-1,e=a(this._options.label.format(t.data),this._options.fontSizeLabels);return i[0]=(this.radius+e.width)*s,i}_midAngle(t){return t.startAngle+(t.endAngle+t.startAngle)/2}_labels(){this.labelsName=this.g.selectAll("text.labelName").data(this.pieData),this.labelsName.enter().append("text").attr("class","labelName").attr("dy",this._options.fontSizeLabels).text((t=>`${this._options.label.format(t.data)}`)).attr("transform",(t=>`translate(${this._posText(t)})`)).attr("text-anchor",(t=>this._midAngle(t)<Math.PI?"start":"end")),this.labelsName.exit().remove(),this.labelsValue=this.g.selectAll("text.labelValue").data(this.pieData),this.labelsValue.enter().append("text").attr("dy",this._options.fontSizeLabels).attr("class","labelValue").text((t=>`${this._options.value.format(t.data)}`)).attr("transform",(t=>`translate(${this._posText(t,!0)})`)).attr("text-anchor",(t=>this._midAngle(t)<Math.PI?"start":"end")),this.labelsValue.exit().remove()}_labelLines(){this.labelLines=this.g.selectAll("polyline.labelLines").data(this.pieData),this.labelLines.enter().append("polyline").attr("class","labelLines").attr("points",(t=>[this.arc.centroid(t),this.outerArc.centroid(t),this._posEndLabelLines(t)])).attr("fill","none").attr("stroke",this._options.style.labelLines.color),this.labelLines.exit().remove()}_addCenterValue(){this.g.append("text").attr("transform","translate(0,0)").attr("text-anchor","middle").style("font-size",this._options.style.centerText.fontSize).style("fill",this._style.color).text(this._options.style.centerText.format)}get options(){return this._options}set options(t){o(this._options,t),this.degree=d3.scaleLinear().range([this._options.startAngle,this._options.endAngle]).domain([this._options.minValue,this._options.maxValue]),this.el.style.maxHeight=this._options.style.maxHeight}_deg2rad(t){return t*Math.PI/180}setArcInBound(t){return t>=this._options.startAngle&&t<=this._options.endAngle?t:t<=this._options.startAngle?this._options.startAngle:this._options.endAngle}draw(t){t&&(this.options=t),this._draw()}}class y extends p{constructor(t,i={},s=null){let e=document.getElementById(t);super(t,i,s=s||Math.min(e.offsetWidth,e.offsetHeight),s,"gauge"),o(this._style,{foregroundColor:"#1abb9b",backgroundColor:r(window.getComputedStyle(this.el).color,h(this.el),.6)}),this.size=s,this.g=this.svg.append("g").attr("transform",`translate(${this.size/2},${this.size/2})`),this._options={value:50,foregroundColor:t=>this._style.foregroundColor,backgroundColor:this._style.backgroundColor,innerRadius:.4*this.size,outerRadius:this.size/2,startAngle:-90,endAngle:90,minValue:0,maxValue:100,displayValue:!0,fontSize:this._style.fontSize,displayText:t=>t,cornerRadius:this.size/10,maxHeight:this.size/2+"px",padAngle:0},this.options=i}_arc(){return d3.arc().innerRadius(this._options.innerRadius).outerRadius(this._options.outerRadius).padAngle(this._options.padAngle).startAngle(this._deg2rad(this._options.startAngle)).cornerRadius(this._options.cornerRadius)}get options(){return this._options}set options(t){o(this._options,t),this.degree=d3.scaleLinear().range([this._options.startAngle,this._options.endAngle]).domain([this._options.minValue,this._options.maxValue]),this.el.style.maxHeight=this._options.maxHeight}_deg2rad(t){return t*Math.PI/180}setArcInBound(t){return t>=this._options.startAngle&&t<=this._options.endAngle?t:t<=this._options.startAngle?this._options.startAngle:this._options.endAngle}draw(t){t&&(this.options=t),this.g.append("path").datum({endAngle:this._deg2rad(this._options.endAngle)}).attr("class","gauge background").attr("fill",this._options.backgroundColor).attr("d",this._arc()),this.g.append("path").datum({endAngle:this._deg2rad(this.setArcInBound(this.degree(this._options.value)))}).attr("class","gauge foreground").attr("fill",this._options.foregroundColor(this._options.value)).attr("d",this._arc()),this.g.append("text").attr("transform","translate(0,0)").attr("text-anchor","middle").style("font-size",this._options.fontSize).style("fill",this._style.color).text(this._options.displayText(this._options.value))}}t.Chart=c,t.Donut=g,t.Gauge=y,t.Grapher=class{constructor(t,i="line",...s){switch(i.toLowerCase()){case"sparkline":case"sparklines":return new _(t,i,...s);case"line":case"bar":case"barline":case"stacked-bar":case"stacked-area":return new c(t,i,...s);case"donut":return new g(t,i,...s);case"gauge":return new y(t,i,...s);default:return console.log(`Error: type ${i} is unknown.`),null}}},t.GrapherBase=p,t.Sparkline=_,t.barycenterColor=r,t.findTimeFormat=i,t.formatTick=function(t,i){return s=>t?Number.isInteger(Math.log10(s))?d3.format(".3s")(s):null:d3.format(i?e(s):".3s")(s)},t.getBackgroundColor=h,t.getDimensionText=a,t.getOptimalPrecision=e,t.longToWide=l,t.splitString=n,t.to_csv=function(t,i=!0){let s="";if(t.length>0){let e=Object.keys(t[0]);i&&(s+=e.join(",")+"\n"),s+=t.map((function(t){let i=[];for(const s of e)i.push('"'+t[s]+'"');return i.join(",")})).join("\n")}return s.toString()},t.unique=s,t.updateDict=o,t.version="1.0.0",t.wideToLong=function(t,i,s="field_id",e="field_value",o,a){let n=[],l=Object.keys(t[0]).filter((t=>!i.includes(t)));for(const r of t)for(const t of l){let l={};l[s]=t,l[e]=r[t];for(const t of i)l[t]=r[t];null!=o&&(l.category=o),null!=a&&(l=a(l)),n.push(l)}return n},Object.defineProperty(t,"__esModule",{value:!0})}));
